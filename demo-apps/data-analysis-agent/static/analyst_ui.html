<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickHouse Data Analyst</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1691.0.min.js"></script>
    <style>
        .analysis-card {
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .result-content {
            max-height: 500px;
            overflow-y: auto;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: #3B82F6;
            color: white;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .insight-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .query-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-3xl mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">ClickHouse Data Analyst</h1>
                        <p class="text-sm text-gray-600">AI-Powered Database Analysis via AgentCore Runtime</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="px-3 py-1 rounded-full text-sm font-medium border">
                        <i class="fas fa-circle mr-1"></i>
                        <span>AgentCore Ready</span>
                    </div>
                    <button id="refresh-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <button class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="analysis">
                    <i class="fas fa-microscope mr-2"></i>Table Analysis
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="insights">
                    <i class="fas fa-lightbulb mr-2"></i>AI Insights
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="query">
                    <i class="fas fa-code mr-2"></i>Query Lab
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="compare">
                    <i class="fas fa-balance-scale mr-2"></i>Compare
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- AWS Credentials Alert -->
        <div id="credentials-alert" class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-gray-700">Loading AWS credentials from environment...</p>
                    <button onclick="testAgentCore()" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        Test AgentCore
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- System Info Card -->
                <div class="metric-card text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-sm font-medium opacity-75">System Status</p>
                            <p class="text-2xl font-bold" id="system-status">Loading...</p>
                        </div>
                        <i class="fas fa-server text-3xl opacity-75"></i>
                    </div>
                </div>

                <!-- Tables Count Card -->
                <div class="insight-card text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-sm font-medium opacity-75">Total Tables</p>
                            <p class="text-2xl font-bold" id="tables-count">Loading...</p>
                        </div>
                        <i class="fas fa-table text-3xl opacity-75"></i>
                    </div>
                </div>

                <!-- Analysis Count Card -->
                <div class="query-card text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-sm font-medium opacity-75">Analyses Run</p>
                            <p class="text-2xl font-bold" id="analysis-count">0</p>
                        </div>
                        <i class="fas fa-chart-bar text-3xl opacity-75"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Tables Overview -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-list mr-2"></i>Available Tables
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="tables-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                <p>Loading tables...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-history mr-2"></i>Recent Activity
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="activity-log" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-clock text-xl mb-2"></i>
                                <p>No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Analysis Controls -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-cogs mr-2"></i>Analysis Controls
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Table</label>
                            <select id="analysis-table-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Loading tables...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Analysis Type</label>
                            <select id="analysis-type-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="full">Full Table Analysis</option>
                                <option value="insights">Data Insights</option>
                                <option value="numeric">Numeric Column Analysis</option>
                                <option value="text">Text Column Analysis</option>
                            </select>
                        </div>

                        <div id="column-select-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Column</label>
                            <select id="analysis-column-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a column...</option>
                            </select>
                        </div>

                        <button id="run-analysis-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-play mr-2"></i>Run Analysis
                        </button>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-chart-area mr-2"></i>Analysis Results
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="analysis-results" class="result-content">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-chart-line text-4xl mb-4"></i>
                                <p class="text-lg">Select a table and analysis type to begin</p>
                                <p class="text-sm">Choose from comprehensive analysis, insights, or column-specific analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- AI Query Interface -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-robot mr-2"></i>AI Data Analyst
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ask the AI Analyst</label>
                            <textarea 
                                id="ai-query-input" 
                                class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none"
                                placeholder="Ask questions about your data...&#10;&#10;Examples:&#10;• Analyze the sales table and find patterns&#10;• What are the key insights about user behavior?&#10;• Compare performance between different regions&#10;• Identify data quality issues in my tables"
                            ></textarea>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <button id="ai-analyze-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-brain mr-2"></i>Analyze
                            </button>
                            <button id="clear-ai-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-eraser mr-1"></i>Clear
                            </button>
                        </div>

                        <!-- Quick AI Queries -->
                        <div class="space-y-2">
                            <p class="text-sm font-medium text-gray-700">Quick Questions:</p>
                            <div class="grid grid-cols-1 gap-2">
                                <button class="ai-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="What tables are available and what insights can you provide?">
                                    📊 Overview of available data
                                </button>
                                <button class="ai-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="Analyze data quality across all tables">
                                    ✅ Data quality assessment
                                </button>
                                <button class="ai-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="Find the most interesting patterns in the data">
                                    🔍 Pattern discovery
                                </button>
                                <button class="ai-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="Generate executive summary of database contents">
                                    📋 Executive summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Results -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-lightbulb mr-2"></i>AI Insights
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="ai-results" class="result-content">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-robot text-4xl mb-4"></i>
                                <p class="text-lg">Ask the AI analyst a question</p>
                                <p class="text-sm">Get intelligent insights about your data using natural language</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Query Lab Tab -->
        <div id="query" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Query Editor -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-code mr-2"></i>SQL Query Editor
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <textarea 
                                id="sql-query-input" 
                                class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none font-mono text-sm"
                                placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT * FROM system.tables LIMIT 10"
                            ></textarea>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <button id="execute-sql-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-play mr-2"></i>Execute
                            </button>
                            <button id="clear-sql-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-eraser mr-1"></i>Clear
                            </button>
                        </div>

                        <!-- Quick Queries -->
                        <div class="space-y-2">
                            <p class="text-sm font-medium text-gray-700">Quick Queries:</p>
                            <div class="grid grid-cols-1 gap-2">
                                <button class="sql-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="SHOW TABLES">
                                    📋 Show all tables
                                </button>
                                <button class="sql-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="SELECT version()">
                                    ℹ️ Database version
                                </button>
                                <button class="sql-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="SELECT * FROM system.databases">
                                    🗄️ Show databases
                                </button>
                                <button class="sql-quick-btn text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm transition-colors" data-query="SELECT name, engine FROM system.tables WHERE database = currentDatabase() LIMIT 10">
                                    🔧 Table engines
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query Results -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-table mr-2"></i>Query Results
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="sql-results" class="result-content">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-database text-4xl mb-4"></i>
                                <p class="text-lg">Execute a query to see results</p>
                                <p class="text-sm">Write SQL queries to explore your data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Tab -->
        <div id="compare" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Comparison Controls -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-balance-scale mr-2"></i>Table Comparison
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Table</label>
                            <select id="compare-table1-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select first table...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Second Table</label>
                            <select id="compare-table2-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select second table...</option>
                            </select>
                        </div>

                        <button id="run-comparison-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-balance-scale mr-2"></i>Compare Tables
                        </button>
                    </div>
                </div>

                <!-- Comparison Results -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-chart-bar mr-2"></i>Comparison Results
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="comparison-results" class="result-content">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-balance-scale text-4xl mb-4"></i>
                                <p class="text-lg">Select two tables to compare</p>
                                <p class="text-sm">Compare structure, size, and characteristics between tables</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <i class="fas fa-spinner loading-spinner text-4xl text-blue-600 mb-4"></i>
            <p class="text-lg font-medium">Processing...</p>
            <p class="text-sm text-gray-600">This may take a few moments</p>
        </div>
    </div>

    <script>
        // Load config from server
        fetch('/config')
            .then(response => response.json())
            .then(config => {
                if (config.accessKeyId && config.secretAccessKey) {
                    AWS.config.update({
                        accessKeyId: config.accessKeyId,
                        secretAccessKey: config.secretAccessKey,
                        region: config.region
                    });
                    
                    document.getElementById('credentials-alert').innerHTML = 
                        '<div class="bg-green-50 border-l-4 border-green-400 p-4"><i class="fas fa-check text-green-400"></i> AWS credentials loaded from environment</div>';
                    
                    window.agentArn = config.agentArn;
                    window.client = new AWS.BedrockAgentCore();
                } else {
                    document.getElementById('credentials-alert').innerHTML = 
                        '<div class="bg-red-50 border-l-4 border-red-400 p-4"><i class="fas fa-exclamation text-red-400"></i> Set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables</div>';
                }
            });

        // Simple test function
        function testAgentCore() {
            if (!window.client) {
                alert('AWS not configured');
                return;
            }
            
            const query = prompt('Enter your question:');
            if (!query) return;
            
            const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substring(2, 15);
            
            const params = {
                runtimeSessionId: sessionId,
                agentRuntimeArn: window.agentArn,
                qualifier: "DEFAULT",
                payload: new TextEncoder().encode(JSON.stringify({ prompt: query }))
            };
            
            window.client.invokeAgentRuntime(params).promise()
                .then(response => {
                    const responseText = new TextDecoder().decode(response.response);
                    const result = JSON.parse(responseText);
                    alert('Response: ' + (result.response || responseText));
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }
    </script>
    <script src="/static/analyst_ui.js"></script>
</body>
</html>